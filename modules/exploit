#!/bin/bash

ExploitLDAP() {
	resultsPath="$outputFolder/$target"
	FILE="$resultsPath/$target.nmap.simple"
	if test -f "$FILE"; then
		ldapResults="$resultsPath/ldap"
		mkdir -p "$ldapResults"
		dn=$(grep <"$FILE" 'Base dn' | awk -F ': ' '{print $2}')
		domain=$(grep <"$FILE" 'Domain name:' | awk -F ': ' '{print $2}')
		ldapsearch=$(ldapsearch -x -b "$dn" -H ldap://"$target"| tee "$ldapResults"/ldapsearch.txt)
		windapsearch=$("$binFolder"/ldap/windapsearch -m users -d "$domain" --dc "$target" -U | tee "$ldapResults"/windapsearch.txt)
		users=$(echo "$windapsearch" | grep 'userPrincipalName' | awk -F ': ' '{print $2}' | tee "$ldapResults"/identifiedUsers.txt)
		ou=$(echo "$windapsearch" | grep "OU=" | awk -F 'OU=' '{$1=""; print $0}' | awk -F 'DC=' '{print $1}' | sed s/,$// | awk -F ',' '{print $1; print $2; print $3;}' | awk '!seen[$0]++' | tee "$resultsPath"/OU.txt)
		objectClass=$("$binFolder"/ldap/windapsearch -m custom --filter="(objectClass=*)" -d "$domain" --dc "$target" -U >"$ldapResults"/objectClasses.txt)
		cn=$(grep <"$ldapResults"/objectClasses.txt -a 'CN=' | awk -F ': ' '{print $2}' | awk -F [=,] '{print $2}' | awk '!seen[$0]++' | tee "$ldapResults"/CN.txt)
	else
		Analyse_Results "$resultsPath"/"$target".nmap
	fi
}

Exploit() {
	protocol=$1
	echo "What is your target IP address?"
	read -r ip
	case $protocol in
	ldap)
		ExploitLDAP "$ip"
		;;
	*)
		ErrorMessage "Not a (currently) supported protocol"
		;;
	esac
}